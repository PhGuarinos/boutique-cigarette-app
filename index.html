<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Boutique E-Cigarettes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .fade-in { opacity: 0; animation: fadeIn 0.5s ease-in forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading border-4 border-blue-500 border-t-transparent rounded-full w-16 h-16 mx-auto mb-4"></div>
            <p class="text-gray-600">Chargement de l'application...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden fixed inset-0 bg-gray-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">Connexion</h2>
            <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            
            <!-- Boutons de connexion -->
            <div class="space-y-4">
                <!-- Connexion Vendeur (sans mot de passe) -->
                <button id="vendeurLoginBtn" class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <span>üë§</span>
                    Acc√®s Vendeur (Consultation)
                </button>
                
                <!-- Connexion Admin (avec mot de passe) -->
                <button id="adminLoginBtn" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <span>‚öôÔ∏è</span>
                    Acc√®s Administrateur
                </button>
            </div>
            
            <!-- Formulaire Admin (masqu√© par d√©faut) -->
            <form id="adminLoginForm" class="hidden mt-4">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mot de passe administrateur</label>
                    <input id="adminPassword" type="password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500"
                           placeholder="Entrez votre mot de passe">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">
                        Se connecter
                    </button>
                    <button type="button" id="cancelAdminLogin" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">Gestion Boutique E-Cigarettes</h1>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600">
                            Connecte en tant que: <strong id="currentUser"></strong>
                            <span id="userRoleBadge" class="ml-2 px-2 py-1 text-xs rounded-full"></span>
                        </span>
                        
                        <!-- Bouton Param√®tres (admin seulement) -->
                        <button id="settingsBtn" class="hidden bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 flex items-center gap-1">
                            <span>‚öôÔ∏è</span> Param√®tres
                        </button>
                        
                        <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            Deconnexion
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Zone de recherche -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="Rechercher un produit..."
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <div class="absolute left-3 top-3 text-gray-400">üîç</div>
                        </div>
                    </div>
                    <select id="searchFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="all">Tous les champs</option>
                        <option value="name">Nom du produit</option>
                        <option value="manufacturer">Fabricant</option>
                        <option value="flavor">Saveur</option>
                    </select>
                </div>
            </div>

            <!-- Barre d'outils Admin -->
            <div id="adminTools" class="hidden bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex flex-wrap gap-3">
                    <button id="addProductBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center gap-2">
                        <span>+</span> Ajouter un produit
                    </button>
                    <div class="relative">
                        <input type="file" id="importFile" accept=".xlsx,.xls,.csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2">
                            <span>‚Üë</span> Importer Excel/CSV
                        </button>
                    </div>
                    <button id="downloadTemplate" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 flex items-center gap-2">
                        <span>‚Üì</span> Telecharger le modele
                    </button>
                    <div class="text-sm text-gray-600 flex items-center">
                        Total: <span id="productCount">0</span> produits
                    </div>
                </div>
            </div>

            <!-- R√©sultats -->
            <div class="mb-4">
                <p id="searchResults" class="text-gray-600">Chargement des produits...</p>
            </div>

            <!-- Grille des produits -->
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Les produits seront charg√©s ici -->
            </div>

            <!-- Message si aucun produit -->
            <div id="noProducts" class="hidden text-center py-12">
                <p class="text-gray-500 text-lg">Aucun produit trouve</p>
            </div>
        </div>
    </div>

    <!-- Modal Param√®tres -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h3 class="text-lg font-bold mb-4">‚öôÔ∏è Param√®tres Administrateur</h3>
            
            <div class="space-y-4">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-800 mb-2">Changer le mot de passe</h4>
                    <form id="changePasswordForm">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe actuel</label>
                                <input id="currentPassword" type="password" required
                                       class="w-full p-2 border rounded focus:ring-2 focus:ring-yellow-500"
                                       placeholder="Mot de passe actuel">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nouveau mot de passe</label>
                                <input id="newPassword" type="password" required
                                       class="w-full p-2 border rounded focus:ring-2 focus:ring-yellow-500"
                                       placeholder="Nouveau mot de passe">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Confirmer le nouveau mot de passe</label>
                                <input id="confirmPassword" type="password" required
                                       class="w-full p-2 border rounded focus:ring-2 focus:ring-yellow-500"
                                       placeholder="Confirmer le mot de passe">
                            </div>
                            <button type="submit" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">
                                Changer le mot de passe
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">Informations</h4>
                    <p class="text-sm text-blue-700 mb-2">
                        <strong>Mode Vendeur :</strong> Acc√®s libre (consultation seule)
                    </p>
                    <p class="text-sm text-blue-700">
                        <strong>Mode Admin :</strong> Acc√®s prot√©g√© par mot de passe
                    </p>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="closeSettings" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ajout/Modification de produit -->
    <div id="productModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
            <h3 id="modalTitle" class="text-lg font-bold mb-4">Ajouter un nouveau produit</h3>
            <form id="productForm">
                <div class="space-y-4">
                    <input type="hidden" id="productId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom du produit *</label>
                        <input id="productName" type="text" required
                               class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fabricant *</label>
                        <input id="productManufacturer" type="text" required
                               class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Saveurs * (separees par des virgules)</label>
                        <input id="productFlavors" type="text" required placeholder="fraise, menthe, citron"
                               class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Image du produit</label>
                        <div class="space-y-3">
                            <!-- Option 1: Upload depuis ordinateur -->
                            <div>
                                <label class="text-sm text-gray-600">Choisir une image depuis votre ordinateur :</label>
                                <input type="file" id="productImageFile" accept="image/*" 
                                       class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                            
                            <!-- Option 2: URL manuelle -->
                            <div>
                                <label class="text-sm text-gray-600">Ou coller une URL d'image :</label>
                                <input id="productImage" type="url" placeholder="https://example.com/image.jpg"
                                       class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Aper√ßu de l'image -->
                            <div id="imagePreviewContainer" class="hidden">
                                <label class="text-sm text-gray-600">Apercu :</label>
                                <div class="relative inline-block">
                                    <img id="imagePreview" src="" alt="Apercu" class="w-32 h-24 object-cover border rounded">
                                    <button type="button" id="removeImage" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                                        √ó
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="productDescription" rows="3"
                                  class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">
                        Enregistrer
                    </button>
                    <button type="button" id="cancelProduct" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-lg font-bold">Previsualisation de l'import</h3>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="importContent">
                    <!-- Contenu de l'import sera ins√©r√© ici -->
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50">
                <div class="flex gap-3 justify-end">
                    <button id="cancelImport" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">
                        Annuler
                    </button>
                    <button id="executeImport" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        Importer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Supabase -->
    <script>
        // Configuration avec vos vraies valeurs Supabase
        const SUPABASE_URL = 'https://vrsnzdukawusuhsguede.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyc256ZHVrYXd1c3Voc2d1ZWRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTExMjQsImV4cCI6MjA2NDQyNzEyNH0.UpA9FR0N5ssj3Br_3M773Cdt0ptRBgCbV_SC8yd6FB4';

        // Initialisation de Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Variables globales
        let currentUser = null;
        let userRole = 'user';
        let allProducts = [];
        let filteredProducts = [];
        let importData = [];
        let adminPassword = 'password123'; // Mot de passe admin par d√©faut

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', async () => {
            await initApp();
        });

        async function initApp() {
            // Charger le mot de passe admin depuis Supabase
            await loadAdminPassword();
            
            // Masquer l'√©cran de chargement et afficher la connexion
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');

            // Gestionnaires d'√©v√©nements
            setupEventListeners();
        }

        async function loadAdminPassword() {
            try {
                const { data, error } = await supabase
                    .from('app_users')
                    .select('password_hash')
                    .eq('username', 'admin')
                    .single();

                if (data && data.password_hash && data.password_hash !== '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi') {
                    // Le mot de passe a √©t√© chang√© depuis la base
                    adminPassword = data.password_hash;
                }
            } catch (error) {
                console.log('Mot de passe par d√©faut utilis√©');
            }
        }

        function setupEventListeners() {
            // Nouveaux boutons de connexion
            document.getElementById('vendeurLoginBtn').addEventListener('click', loginAsVendeur);
            document.getElementById('adminLoginBtn').addEventListener('click', showAdminLogin);
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('cancelAdminLogin').addEventListener('click', hideAdminLogin);
            
            // Param√®tres
            document.getElementById('settingsBtn').addEventListener('click', showSettings);
            document.getElementById('closeSettings').addEventListener('click', hideSettings);
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Recherche
            document.getElementById('searchInput').addEventListener('input', filterProducts);
            document.getElementById('searchFilter').addEventListener('change', filterProducts);

            // Admin
            document.getElementById('addProductBtn').addEventListener('click', () => openProductModal());
            document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
            document.getElementById('importFile').addEventListener('change', handleFileImport);

            // Modals
            document.getElementById('cancelProduct').addEventListener('click', closeProductModal);
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('cancelImport').addEventListener('click', closeImportModal);
            document.getElementById('executeImport').addEventListener('click', executeImport);

            // Gestion des images
            document.getElementById('productImageFile').addEventListener('change', handleImageUpload);
            document.getElementById('productImage').addEventListener('input', handleImageUrlChange);
            document.getElementById('removeImage').addEventListener('click', clearImagePreview);
        }

        function loginAsVendeur() {
            currentUser = 'vendeur';
            userRole = 'user';
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUser').textContent = 'Vendeur';
            
            // Badge vendeur
            const badge = document.getElementById('userRoleBadge');
            badge.textContent = 'Consultation';
            badge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800';
            
            loadProducts();
        }

        function showAdminLogin() {
            document.getElementById('adminLoginForm').classList.remove('hidden');
            document.getElementById('vendeurLoginBtn').classList.add('hidden');
            document.getElementById('adminLoginBtn').classList.add('hidden');
            document.getElementById('adminPassword').focus();
        }

        function hideAdminLogin() {
            document.getElementById('adminLoginForm').classList.add('hidden');
            document.getElementById('vendeurLoginBtn').classList.remove('hidden');
            document.getElementById('adminLoginBtn').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;

            try {
                // V√©rifier le mot de passe
                if (password === 'password123' || password === adminPassword) {
                    currentUser = 'admin';
                    userRole = 'admin';
                    
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = 'Administrateur';
                    
                    // Badge admin et bouton param√®tres
                    const badge = document.getElementById('userRoleBadge');
                    badge.textContent = 'Administrateur';
                    badge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
                    
                    document.getElementById('adminTools').classList.remove('hidden');
                    document.getElementById('settingsBtn').classList.remove('hidden');
                    
                    await loadProducts();
                } else {
                    showLoginError('Mot de passe incorrect');
                }
            } catch (error) {
                showLoginError('Erreur de connexion: ' + error.message);
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function handleLogout() {
            currentUser = null;
            userRole = 'user';
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminTools').classList.add('hidden');
            document.getElementById('settingsBtn').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            hideAdminLogin();
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function hideSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('changePasswordForm').reset();
        }

        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;

            // V√©rifications
            if (currentPwd !== 'password123' && currentPwd !== adminPassword) {
                alert('Mot de passe actuel incorrect');
                return;
            }

            if (newPwd.length < 6) {
                alert('Le nouveau mot de passe doit contenir au moins 6 caract√®res');
                return;
            }

            if (newPwd !== confirmPwd) {
                alert('Les mots de passe ne correspondent pas');
                return;
            }

            try {
                // Mettre √† jour dans Supabase
                const { error } = await supabase
                    .from('app_users')
                    .update({ password_hash: newPwd })
                    .eq('username', 'admin');

                if (error) throw error;

                // Mettre √† jour localement
                adminPassword = newPwd;
                
                alert('Mot de passe chang√© avec succ√®s !');
                hideSettings();
            } catch (error) {
                alert('Erreur lors du changement de mot de passe: ' + error.message);
            }
        }

        async function loadProducts() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                allProducts = data || [];
                filteredProducts = [...allProducts];
                renderProducts();
                updateProductCount();
            } catch (error) {
                console.error('Erreur lors du chargement des produits:', error);
                document.getElementById('searchResults').textContent = 'Erreur de chargement des produits';
            }
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const searchBy = document.getElementById('searchFilter').value;

            if (!searchTerm) {
                filteredProducts = [...allProducts];
            } else {
                filteredProducts = allProducts.filter(product => {
                    switch (searchBy) {
                        case 'name':
                            return product.name.toLowerCase().includes(searchTerm);
                        case 'manufacturer':
                            return product.manufacturer.toLowerCase().includes(searchTerm);
                        case 'flavor':
                            return product.flavors.some(flavor => 
                                flavor.toLowerCase().includes(searchTerm)
                            );
                        default:
                            return (
                                product.name.toLowerCase().includes(searchTerm) ||
                                product.manufacturer.toLowerCase().includes(searchTerm) ||
                                product.flavors.some(flavor => 
                                    flavor.toLowerCase().includes(searchTerm)
                                )
                            );
                    }
                });
            }

            renderProducts();
            updateSearchResults();
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const noProducts = document.getElementById('noProducts');

            if (filteredProducts.length === 0) {
                grid.classList.add('hidden');
                noProducts.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            noProducts.classList.add('hidden');

            grid.innerHTML = filteredProducts.map(product => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow fade-in">
                    <img src="${product.image_url || 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=300&h=200&fit=crop'}" 
                         alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${product.name}</h3>
                        <p class="text-sm text-gray-600 mb-2">
                            <strong>Fabricant:</strong> ${product.manufacturer}
                        </p>
                        <div class="mb-3">
                            <span class="text-sm font-semibold text-gray-600">Saveurs:</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${product.flavors.map(flavor => 
                                    `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${flavor}</span>`
                                ).join('')}
                            </div>
                        </div>
                        ${product.description ? `<p class="text-sm text-gray-600 mb-3">${product.description}</p>` : ''}
                        
                        ${userRole === 'admin' ? `
                            <div class="flex gap-2">
                                <button onclick="editProduct(${product.id})" 
                                        class="flex-1 bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">
                                    Modifier
                                </button>
                                <button onclick="deleteProduct(${product.id})" 
                                        class="flex-1 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                    Supprimer
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateProductCount() {
            document.getElementById('productCount').textContent = allProducts.length;
        }

        function updateSearchResults() {
            const searchTerm = document.getElementById('searchInput').value;
            const results = document.getElementById('searchResults');
            
            if (searchTerm) {
                results.textContent = `${filteredProducts.length} produit(s) trouve(s) pour "${searchTerm}"`;
            } else {
                results.textContent = `${filteredProducts.length} produit(s) au total`;
            }
        }

        function openProductModal(product = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('modalTitle');
            
            if (product) {
                title.textContent = 'Modifier le produit';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productManufacturer').value = product.manufacturer;
                document.getElementById('productFlavors').value = product.flavors.join(', ');
                document.getElementById('productImage').value = product.image_url || '';
                document.getElementById('productDescription').value = product.description || '';
                
                if (product.image_url) {
                    showImagePreview(product.image_url);
                }
            } else {
                title.textContent = 'Ajouter un nouveau produit';
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                clearImagePreview();
            }
            
            modal.classList.remove('hidden');
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Veuillez selectionner un fichier image valide (JPG, PNG, GIF)');
                event.target.value = '';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('L\'image est trop volumineuse. Taille maximum : 5MB');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                showImagePreview(base64Image);
                document.getElementById('productImage').value = base64Image;
            };
            reader.readAsDataURL(file);
        }

        function handleImageUrlChange(event) {
            const url = event.target.value;
            if (url && url.startsWith('http')) {
                showImagePreview(url);
            } else if (!url) {
                clearImagePreview();
            }
        }

        function showImagePreview(imageSrc) {
            const container = document.getElementById('imagePreviewContainer');
            const preview = document.getElementById('imagePreview');
            
            preview.src = imageSrc;
            container.classList.remove('hidden');
        }

        function clearImagePreview() {
            const container = document.getElementById('imagePreviewContainer');
            const preview = document.getElementById('imagePreview');
            const fileInput = document.getElementById('productImageFile');
            const urlInput = document.getElementById('productImage');
            
            preview.src = '';
            container.classList.add('hidden');
            fileInput.value = '';
            urlInput.value = '';
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            clearImagePreview();
        }

        async function saveProduct(e) {
            e.preventDefault();
            
            const id = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const manufacturer = document.getElementById('productManufacturer').value;
            const flavors = document.getElementById('productFlavors').value.split(',').map(f => f.trim());
            const image_url = document.getElementById('productImage').value;
            const description = document.getElementById('productDescription').value;

            const productData = {
                name,
                manufacturer,
                flavors,
                image_url,
                description
            };

            try {
                if (id) {
                    const { error } = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', id);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('products')
                        .insert([productData]);
                    
                    if (error) throw error;
                }
                
                closeProductModal();
                await loadProducts();
                alert(id ? 'Produit modifie avec succes!' : 'Produit ajoute avec succes!');
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        async function editProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (product) {
                openProductModal(product);
            }
        }

        async function deleteProduct(id) {
            if (confirm('Etes-vous sur de vouloir supprimer ce produit ?')) {
                try {
                    const { error } = await supabase
                        .from('products')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    await loadProducts();
                    alert('Produit supprime avec succes!');
                } catch (error) {
                    alert('Erreur lors de la suppression: ' + error.message);
                }
            }
        }

        function downloadTemplate() {
            const template = [
                ['Nom', 'Fabricant', 'Saveurs', 'Image', 'Description'],
                ['Fruit Mix Premium', 'VapeMax', 'fraise,mangue,kiwi', 'https://example.com/image.jpg', 'Melange fruit√©'],
                ['Menthol Ice', 'CoolVape', 'menthe,eucalyptus', '', 'Fraicheur intense'],
                ['Vanilla Cream', 'SweetCloud', 'vanille,creme', '', 'Douceur onctueuse']
            ];
            
            const csv = template.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'template_produits.csv';
            link.click();
        }

        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                let data = [];
                const fileName = file.name.toLowerCase();
                
                console.log('Import de fichier:', fileName);
                
                if (fileName.endsWith('.csv')) {
                    const text = await file.text();
                    console.log('Contenu brut CSV (100 premiers caracteres):', text.substring(0, 100));
                    data = parseCSVAdvanced(text);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer);
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (jsonData.length > 1) {
                        const headers = jsonData[0];
                        data = jsonData.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                    }
                }
                
                console.log('Donnees parsees:', data.slice(0, 2));
                
                importData = processImportData(data);
                showImportPreview();
            } catch (error) {
                console.error('Erreur import:', error);
                alert('Erreur lors de l\'import: ' + error.message);
            }
            
            event.target.value = '';
        }

        function parseCSVAdvanced(text) {
            console.log('=== DEBUT ANALYSE CSV ===');
            
            text = text.trim();
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            console.log('Nombre de lignes:', lines.length);
            
            if (lines.length <= 1) {
                console.log('Fichier vide ou une seule ligne');
                return [];
            }
            
            const firstLine = lines[0];
            console.log('Premiere ligne brute:', firstLine);
            
            const separators = [',', ';', '\t', '|'];
            let bestSeparator = ',';
            let maxColumns = 0;
            
            separators.forEach(sep => {
                const testSplit = splitCSVLine(firstLine, sep);
                const columns = testSplit.length;
                console.log(`Test separateur "${sep}": ${columns} colonnes`, testSplit);
                
                if (columns > maxColumns && columns >= 3) {
                    maxColumns = columns;
                    bestSeparator = sep;
                }
            });
            
            console.log(`Separateur choisi: "${bestSeparator}" (${maxColumns} colonnes)`);
            
            const headers = splitCSVLine(firstLine, bestSeparator).map(h => h.trim());
            console.log('Headers detectes:', headers);
            
            const result = lines.slice(1).map((line, index) => {
                const values = splitCSVLine(line, bestSeparator);
                const obj = {};
                headers.forEach((header, idx) => {
                    obj[header] = (values[idx] || '').trim();
                });
                
                if (index < 2) {
                    console.log(`Ligne ${index + 1}:`, obj);
                }
                
                return obj;
            });
            
            console.log('=== FIN ANALYSE CSV ===');
            return result;
        }
        
        function splitCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i += 2;
                        continue;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                    i++;
                    continue;
                } else {
                    current += char;
                }
                i++;
            }
            
            result.push(current);
            
            return result.map(field => {
                field = field.trim();
                if (field.startsWith('"') && field.endsWith('"')) {
                    field = field.slice(1, -1);
                }
                return field;
            });
        }

        function processImportData(data) {
            return data.map(row => {
                const name = findField(row, ['nom', 'name', 'produit']);
                const manufacturer = findField(row, ['fabricant', 'manufacturer', 'marque']);
                const flavorsStr = findField(row, ['saveurs', 'flavors', 'saveur']);
                const image_url = findField(row, ['image', 'image_url', 'photo']);
                const description = findField(row, ['description', 'desc']);
                
                return {
                    name: name || '',
                    manufacturer: manufacturer || '',
                    flavors: flavorsStr ? flavorsStr.split(/[,;|]/).map(f => f.trim()).filter(f => f) : [],
                    image_url: image_url || '',
                    description: description || '',
                    valid: !!(name && manufacturer && flavorsStr)
                };
            }).filter(item => item.name || item.manufacturer);
        }

        function findField(row, possibleNames) {
            for (const name of possibleNames) {
                const field = Object.keys(row).find(key => 
                    key.toLowerCase().includes(name.toLowerCase())
                );
                if (field && row[field]) {
                    return row[field];
                }
            }
            return null;
        }

        function showImportPreview() {
            const validProducts = importData.filter(p => p.valid);
            const invalidProducts = importData.filter(p => !p.valid);
            
            document.getElementById('importContent').innerHTML = `
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <div class="text-green-600 text-2xl font-bold">${validProducts.length}</div>
                        <div class="text-green-800 font-semibold">Produits valides</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-red-600 text-2xl font-bold">${invalidProducts.length}</div>
                        <div class="text-red-800 font-semibold">Erreurs</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-blue-600 text-2xl font-bold">${importData.length}</div>
                        <div class="text-blue-800 font-semibold">Total lignes</div>
                    </div>
                </div>
                
                ${validProducts.length > 0 ? `
                    <div class="mb-6">
                        <h4 class="font-semibold text-green-800 mb-3">Produits a importer (${validProducts.length})</h4>
                        <div class="border rounded-lg overflow-hidden max-h-60 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left p-2">Nom</th>
                                        <th class="text-left p-2">Fabricant</th>
                                        <th class="text-left p-2">Saveurs</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${validProducts.slice(0, 10).map(product => `
                                        <tr class="border-t">
                                            <td class="p-2 font-medium">${product.name}</td>
                                            <td class="p-2">${product.manufacturer}</td>
                                            <td class="p-2">${product.flavors.join(', ')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('executeImport').disabled = validProducts.length === 0;
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            importData = [];
        }

        async function executeImport() {
            const validProducts = importData.filter(p => p.valid);
            
            try {
                const { error } = await supabase
                    .from('products')
                    .insert(validProducts.map(p => ({
                        name: p.name,
                        manufacturer: p.manufacturer,
                        flavors: p.flavors,
                        image_url: p.image_url,
                        description: p.description
                    })));
                
                if (error) throw error;
                
                closeImportModal();
                await loadProducts();
                alert(`${validProducts.length} produit(s) importe(s) avec succes!`);
            } catch (error) {
                alert('Erreur lors de l\'import: ' + error.message);
            }
        }
    </script>
</body>
</html>
